---
phase: 19-gateway-connection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ui/package.json
  - ui/src/ui/state/connection.ts
  - ui/src/ui/components/connection-indicator.ts
autonomous: true

must_haves:
  truths:
    - "@lit-labs/signals is installed and importable in the UI project"
    - "Connection state is represented as a signal with three values: connected, reconnecting, disconnected"
    - "A connection indicator component renders the current connection status visually"
  artifacts:
    - path: "ui/src/ui/state/connection.ts"
      provides: "Shared connection state signals"
      exports: ["connectionStatus", "ConnectionStatus", "setConnectionStatus"]
    - path: "ui/src/ui/components/connection-indicator.ts"
      provides: "Visual connection status indicator"
      contains: "customElement"
  key_links:
    - from: "ui/src/ui/components/connection-indicator.ts"
      to: "ui/src/ui/state/connection.ts"
      via: "signal import"
      pattern: "import.*connectionStatus.*from.*state/connection"
---

<objective>
Install @lit-labs/signals and create the shared connection state layer with a connection indicator component.

Purpose: Provide the reactive foundation (signals) and a visible connection status indicator that multiple components can consume without prop-drilling through the monolithic app state.
Output: @lit-labs/signals installed, connection signal module, connection-indicator Lit component.
</objective>

<execution_context>
@/Users/lucassenechal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucassenechal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

Key files to understand existing patterns:
@ui/package.json
@ui/src/ui/gateway.ts — GatewayBrowserClient with existing auto-reconnect (800ms→15s backoff)
@ui/src/ui/app.ts — Main app component using @state() decorators, has `connected` boolean
@ui/src/ui/app-gateway.ts — connectGateway() function, onHello/onClose callbacks
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @lit-labs/signals and create connection state signals</name>
  <files>ui/package.json, ui/src/ui/state/connection.ts</files>
  <action>
1. Install @lit-labs/signals pinned to exact version 0.2.0 in ui/package.json dependencies:
   Run `cd ui && pnpm add @lit-labs/signals@0.2.0 --save-exact` from the repo root.

2. Create `ui/src/ui/state/connection.ts` — the shared connection state module:

```typescript
import { signal, computed } from '@lit-labs/signals';

export type ConnectionStatus = 'connected' | 'reconnecting' | 'disconnected';

// Core signal: current connection status
export const connectionStatus = signal<ConnectionStatus>('disconnected');

// Computed convenience signals
export const isConnected = computed(() => connectionStatus.get() === 'connected');
export const isReconnecting = computed(() => connectionStatus.get() === 'reconnecting');

// Mutation helpers (called from app-gateway.ts)
export function setConnectionStatus(status: ConnectionStatus) {
  connectionStatus.set(status);
}
```

Key design decisions:
- Use `signal()` from @lit-labs/signals (NOT from @preact/signals-core directly — @lit-labs/signals re-exports with Lit integration)
- Pin exact version 0.2.0 because this is an experimental Lit Labs package
- Export both the raw signal and typed mutation helper for explicit call sites
- Keep this module minimal — it is shared state, not business logic
  </action>
  <verify>
Run `cd /Users/lucassenechal/clawd/openclaw/ui && pnpm build` to confirm:
- @lit-labs/signals resolves correctly
- connection.ts compiles without errors
- No type errors in the build output
  </verify>
  <done>
@lit-labs/signals@0.2.0 is in ui/package.json dependencies. `ui/src/ui/state/connection.ts` exports connectionStatus signal, ConnectionStatus type, and setConnectionStatus helper. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create connection-indicator component</name>
  <files>ui/src/ui/components/connection-indicator.ts</files>
  <action>
Create `ui/src/ui/components/connection-indicator.ts` — a Lit component that reads the connection signal and renders a status indicator.

```typescript
import { LitElement, html, css } from 'lit';
import { customElement } from 'lit/decorators.js';
import { SignalWatcher } from '@lit-labs/signals';
import { connectionStatus, type ConnectionStatus } from '../state/connection';

@customElement('connection-indicator')
export class ConnectionIndicator extends SignalWatcher(LitElement) {
  static styles = css`
    :host {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      line-height: 1;
    }
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .dot.connected { background: #22c55e; }
    .dot.reconnecting {
      background: #f59e0b;
      animation: pulse 1.2s ease-in-out infinite;
    }
    .dot.disconnected { background: #ef4444; }
    .label { opacity: 0.7; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
  `;

  render() {
    const status: ConnectionStatus = connectionStatus.get();
    const label = status === 'connected' ? 'Connected'
      : status === 'reconnecting' ? 'Reconnecting...'
      : 'Disconnected';
    return html`
      <span class="dot ${status}"></span>
      <span class="label">${label}</span>
    `;
  }
}
```

Key design decisions:
- Use `SignalWatcher` mixin (NOT `watch()` directive) so the entire component auto-re-renders when any signal it reads changes. This is the recommended pattern from @lit-labs/signals docs for components that primarily consume signals.
- Component uses Shadow DOM with scoped styles (LitElement default) — this is a self-contained indicator widget.
- Green/amber/red dot with text label. Amber pulses to indicate activity.
- No props needed — it reads directly from the shared signal. This is the whole point of signals.
  </action>
  <verify>
Run `cd /Users/lucassenechal/clawd/openclaw/ui && pnpm build` to confirm:
- connection-indicator.ts compiles
- SignalWatcher import resolves
- No type errors
  </verify>
  <done>
`connection-indicator` custom element exists, extends SignalWatcher(LitElement), reads connectionStatus signal, renders a colored dot + text label for connected/reconnecting/disconnected states. Build passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` in ui/ succeeds with no errors
- @lit-labs/signals@0.2.0 appears in ui/node_modules/@lit-labs/signals/package.json
- `ui/src/ui/state/connection.ts` exports: connectionStatus, ConnectionStatus, setConnectionStatus, isConnected, isReconnecting
- `ui/src/ui/components/connection-indicator.ts` defines `connection-indicator` custom element
</verification>

<success_criteria>
- @lit-labs/signals installed at exact version 0.2.0
- Shared connection signal module created with typed status enum
- Connection indicator component created with SignalWatcher mixin
- All three connection states visually distinct (green dot / amber pulsing dot / red dot + labels)
- UI build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/19-gateway-connection/19-01-SUMMARY.md`
</output>
