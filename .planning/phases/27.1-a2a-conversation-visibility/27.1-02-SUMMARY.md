---
phase: 27.1-a2a-conversation-visibility
plan: 02
subsystem: ui-state
tags:
  - a2a
  - signals
  - typescript
  - lit
  - reactive-state
requires:
  - 27.1-01
provides:
  - a2aConversations signal with turn tracking
  - sessionA2ALinks computed signal for session cross-referencing
  - A2A event routing in AgentsController
affects:
  - 27.1-03
tech-stack:
  added: []
  patterns:
    - "Immutable Map pattern for Lit signals"
    - "Computed signals for derived state"
key-files:
  created: []
  modified:
    - ui/src/ui/state/metrics.ts
    - ui/src/ui/controllers/agents-controller.ts
decisions:
  - id: a2a-signal-structure
    choice: "Separate A2AConversation type with ordered turns array"
    rationale: "Distinct from session conversations - needs conversationId, turn sequencing, and bi-directional agent metadata"
  - id: session-linking
    choice: "sessionA2ALinks computed signal maps sessionKey -> conversationIds[]"
    rationale: "Enables session cards to show related A2A conversations without duplicating data"
  - id: immutable-map-pattern
    choice: "new Map(signal.get()) before every mutation"
    rationale: "Required by Lit signals for reactivity - same pattern as sessionConversations"
metrics:
  duration: 2 min
  completed: 2026-02-03
---

# Phase 27.1 Plan 02: UI State Layer for A2A Conversations

**One-liner:** Reactive signals layer for tracking agent-to-agent conversation turns with session linking via a2aConversations Map and computed cross-reference signal.

## What Was Built

Added the complete UI state layer for A2A (agent-to-agent) conversations to support the Phase 27.1 goal of making inter-agent conversations visible in the dashboard.

**New Types:**

- `A2ATurnMessage`: Single conversation turn with conversationId, fromAgent, toAgent, turn number, maxTurns, text, timestamp, and optional sessionKey
- `A2AConversation`: Full conversation with conversationId, agents tuple, turns array, startedAt timestamp, and status (active/complete)

**New Signals:**

- `a2aConversations`: Primary signal storing Map<conversationId, A2AConversation>
- `sessionA2ALinks`: Computed signal producing Map<sessionKey, conversationIds[]> for session card indicators

**New Mutators:**

- `pushA2ATurn(turn)`: Appends turn to existing conversation or creates new conversation if first turn
- `finalizeA2AConversation(conversationId)`: Marks conversation status as "complete"

**Controller Routing:**

- AgentsController.handleEvent now routes `stream === "a2a"` events:
  - `phase === "turn"`: Calls pushA2ATurn with full metadata including sessionKey
  - `phase === "complete"`: Calls finalizeA2AConversation
- resetMetrics now clears a2aConversations signal

## Implementation Details

**Signal Pattern:**

Followed exact same immutable Map pattern as existing `sessionConversations` signal:

```typescript
const next = new Map(a2aConversations.get());
// ... mutations on next ...
a2aConversations.set(next);
```

This pattern is required by Lit signals for reactive updates.

**Session Linking Strategy:**

The `sessionA2ALinks` computed signal iterates all A2A conversations and builds a reverse index from sessionKey to conversationIds. This allows:

- Session cards to show "has related A2A conversation" indicators
- Drill-down from session card to threaded A2A view (plan 27.1-03)
- No data duplication (single source of truth in a2aConversations)

**Event Routing:**

AgentsController extracts conversation metadata from gateway `stream: "a2a"` events and populates turn records with:

- Conversation metadata (conversationId, fromAgent, toAgent, turn, maxTurns)
- Message text
- Timestamp (Date.now() on receipt)
- Session link (sessionKey from payload for cross-referencing)

## Files Modified

**ui/src/ui/state/metrics.ts** (~74 LOC added):

- Added A2ATurnMessage and A2AConversation types
- Added a2aConversations signal
- Added sessionA2ALinks computed signal
- Added pushA2ATurn and finalizeA2AConversation mutators
- Updated resetMetrics to clear A2A state

**ui/src/ui/controllers/agents-controller.ts** (~22 LOC added):

- Imported pushA2ATurn and finalizeA2AConversation
- Added `else if (payload.stream === "a2a")` block in handleEvent
- Routes turn events to pushA2ATurn with full metadata
- Routes complete events to finalizeA2AConversation

## Testing

**Build verification:** `pnpm build` passed with no TypeScript errors
**Test suite:** All existing tests pass (some pre-existing failures in unrelated local-routing tests)
**Manual verification:**

- Confirmed a2aConversations signal exists in metrics.ts
- Confirmed pushA2ATurn routing exists in agents-controller.ts
- Confirmed resetMetrics clears A2A state

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

**Ready for 27.1-03 (UI Rendering):**

- a2aConversations signal is populated and reactive
- sessionA2ALinks provides session card cross-referencing data
- Conversation status tracking (active/complete) is in place
- Turn ordering is maintained via array append pattern

**Blockers:** None

**Concerns:** None

## Success Criteria

- [x] A2ATurnMessage and A2AConversation types are exported
- [x] a2aConversations signal exists and follows immutable Map pattern
- [x] sessionA2ALinks computed signal provides session cross-referencing
- [x] pushA2ATurn and finalizeA2AConversation mutators are exported
- [x] AgentsController routes stream === "a2a" events to signal layer
- [x] resetMetrics clears a2aConversations
- [x] `pnpm build` passes with no TypeScript errors

## Task Commits

| Task | Description                          | Commit    | Files Modified                             |
| ---- | ------------------------------------ | --------- | ------------------------------------------ |
| 1    | Add A2A types, signal, and mutators  | d403c404e | ui/src/ui/state/metrics.ts                 |
| 2    | Route A2A events in AgentsController | 79408d5f6 | ui/src/ui/controllers/agents-controller.ts |

---

**Phase:** 27.1-a2a-conversation-visibility
**Plan:** 02
**Completed:** 2026-02-03
**Duration:** 2 minutes
