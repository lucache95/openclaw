---
phase: 27.1
plan: 01
subsystem: agent-events
tags: [a2a, events, conversation, ping-pong, backend]
dependencies:
  requires: [26-01, 27-01, 27-02]
  provides: [a2a-conversation-events]
  affects: [27.1-02]
tech-stack:
  added: []
  patterns: [event-emission, conversation-tracking]
key-files:
  created: []
  modified:
    - src/agents/tools/agent-step.ts
    - src/agents/tools/sessions-send-tool.a2a.ts
decisions:
  - id: a2a-event-stream
    choice: Use existing stream:'a2a' type in emitAgentEvent
    rationale: Gateway already broadcasts all non-'tool' streams; no gateway changes needed
  - id: conversation-id-generation
    choice: Generate conversationId with crypto.randomUUID()
    rationale: Unique identifier per A2A conversation for UI threading
  - id: turn-numbering
    choice: Turn 0 = initial message, turn 1 = round-one reply, turns 2+ = ping-pong
    rationale: Captures the full conversation flow including the initial exchange
  - id: reply-skip-filtering
    choice: Filter REPLY_SKIP from A2A events in agent-step.ts
    rationale: REPLY_SKIP is a control signal, not conversation content
  - id: announce-exclusion
    choice: Announce step does NOT emit A2A events
    rationale: Announce is a delivery mechanism, not part of the conversation
metrics:
  duration: 4 min
  completed: 2026-02-03
  loc-added: 89
  loc-modified: ~20
---

# Phase 27.1 Plan 01: A2A Conversation Event Emission Summary

**One-liner:** Backend emits A2A conversation events with conversationId, fromAgent, toAgent, turn, and text for every ping-pong turn.

## What Was Built

Modified the A2A ping-pong flow to emit conversation events through the existing agent event pipeline:

1. **agent-step.ts enhancements:**
   - Added optional `a2aContext` parameter to `runAgentStep`
   - Emits `stream: "a2a"` events after step completion when a2aContext is provided
   - Filters REPLY_SKIP responses from A2A event emission
   - Backward compatible: existing callers unaffected

2. **sessions-send-tool.a2a.ts enhancements:**
   - Generates unique `conversationId` per A2A flow
   - Resolves agent IDs from session keys for fromAgent/toAgent fields
   - Emits turn 0 (requester's initial message)
   - Emits turn 1 (target's round-one reply)
   - Passes a2aContext to each ping-pong turn (turns 2+)
   - Emits "complete" phase event after ping-pong loop
   - Excludes announce step from A2A events

## Implementation Details

### Event Structure

Each A2A turn event contains:

```typescript
{
  runId: string,          // Auto-assigned by gateway
  seq: number,            // Auto-assigned by emitAgentEvent
  ts: number,             // Auto-assigned by emitAgentEvent
  sessionKey: string,     // Enriched from run context
  stream: "a2a",          // Stream type for gateway filtering
  data: {
    conversationId: string,  // UUID per conversation
    fromAgent: string,       // Sender agent ID
    toAgent: string,         // Recipient agent ID
    turn: number,            // 0 = initial, 1 = round-one, 2+ = ping-pong
    maxTurns: number,        // Config value
    text: string,            // Message text
    phase: "turn"            // "turn" or "complete"
  }
}
```

### Turn Flow

1. **Turn 0:** Requester's initial message (emitted in sessions-send-tool.a2a.ts)
2. **Turn 1:** Target's round-one reply (emitted in sessions-send-tool.a2a.ts)
3. **Turns 2-N:** Ping-pong exchanges (emitted by runAgentStep via a2aContext)
4. **Complete event:** After loop exits (no turn number, phase="complete")

### REPLY_SKIP Handling

- REPLY_SKIP is a control signal to exit the ping-pong loop
- Filtered in agent-step.ts: `if (params.a2aContext && replyText && !isReplySkip(replyText))`
- When REPLY_SKIP detected, loop breaks before emitting event
- Complete event still emitted after loop

### Announce Step Exclusion

- The announce step is a delivery mechanism (posts to target channel)
- Not part of the A2A conversation flow
- runAgentStep call for announce does NOT include a2aContext parameter
- No A2A event emitted for announce step

## Code Changes

### src/agents/tools/agent-step.ts

**Imports added:**

- `emitAgentEvent` from `../../infra/agent-events.js`
- `isReplySkip` from `./sessions-send-helpers.js`

**Parameter extension:**

```typescript
a2aContext?: {
  conversationId: string;
  fromAgent: string;
  toAgent: string;
  turn: number;
  maxTurns: number;
};
```

**Event emission (after readLatestAssistantReply):**

```typescript
if (params.a2aContext && replyText && !isReplySkip(replyText)) {
  emitAgentEvent({
    runId: resolvedRunId,
    stream: "a2a",
    data: {
      conversationId: params.a2aContext.conversationId,
      fromAgent: params.a2aContext.fromAgent,
      toAgent: params.a2aContext.toAgent,
      turn: params.a2aContext.turn,
      maxTurns: params.a2aContext.maxTurns,
      text: replyText,
      phase: "turn",
    },
  });
}
```

### src/agents/tools/sessions-send-tool.a2a.ts

**Imports added:**

- `emitAgentEvent` from `../../infra/agent-events.js`
- `resolveAgentIdFromSessionKey` from `../../routing/session-key.js`

**ConversationId generation:**

```typescript
const conversationId = crypto.randomUUID();
const requesterAgentId = params.requesterSessionKey
  ? resolveAgentIdFromSessionKey(params.requesterSessionKey)
  : "unknown";
const targetAgentId = resolveAgentIdFromSessionKey(params.targetSessionKey);
```

**Turn 0/1 emission (after primaryReply resolved):**

```typescript
// Emit turn 0: requester's initial message
emitAgentEvent({
  runId: runContextId,
  stream: "a2a",
  data: {
    conversationId,
    fromAgent: requesterAgentId,
    toAgent: targetAgentId,
    turn: 0,
    maxTurns: params.maxPingPongTurns,
    text: params.message,
    phase: "turn",
  },
});

// Emit turn 1: target's round-one reply
if (primaryReply) {
  emitAgentEvent({
    runId: runContextId,
    stream: "a2a",
    data: {
      conversationId,
      fromAgent: targetAgentId,
      toAgent: requesterAgentId,
      turn: 1,
      maxTurns: params.maxPingPongTurns,
      text: primaryReply,
      phase: "turn",
    },
  });
}
```

**Ping-pong loop a2aContext:**

```typescript
const currentAgentId =
  currentSessionKey === params.requesterSessionKey ? requesterAgentId : targetAgentId;
const otherAgentId = currentAgentId === requesterAgentId ? targetAgentId : requesterAgentId;
const replyText = await runAgentStep({
  sessionKey: currentSessionKey,
  message: incomingMessage,
  extraSystemPrompt: replyPrompt,
  timeoutMs: params.announceTimeoutMs,
  lane: AGENT_LANE_NESTED,
  a2aContext: {
    conversationId,
    fromAgent: currentAgentId,
    toAgent: otherAgentId,
    turn: turn + 1,
    maxTurns: params.maxPingPongTurns,
  },
});
```

**Complete event (after loop):**

```typescript
emitAgentEvent({
  runId: runContextId,
  stream: "a2a",
  data: {
    conversationId,
    fromAgent: requesterAgentId,
    toAgent: targetAgentId,
    phase: "complete",
  },
});
```

## Testing & Verification

**Build verification:**

- `pnpm build` passed with no TypeScript errors
- `a2aContext` parameter is optional (existing callers unaffected)

**Code verification:**

- `stream: "a2a"` confirmed in agent-step.ts
- `conversationId` generation confirmed in sessions-send-tool.a2a.ts
- `isReplySkip` filtering confirmed in agent-step.ts
- Announce step runAgentStep call does NOT have a2aContext parameter

**Gateway broadcast:**

- Gateway already broadcasts all non-'tool' streams unconditionally
- `stream: "a2a"` events will pass through to UI clients
- No gateway code changes required

## Deviations from Plan

None - plan executed exactly as written.

## Known Limitations

1. **No message deduplication:** If multiple A2A flows happen concurrently with the same participants, events are emitted separately (intended behavior).

2. **No persistence:** Events are ephemeral - only clients connected to the WebSocket receive them. Reconnecting clients won't see historical A2A conversations (future work).

3. **No error events:** If a ping-pong turn fails (timeout, error), no A2A event is emitted for that turn. The loop breaks and complete event fires.

## Next Phase Readiness

**Phase 27.1-02 (UI A2A Conversation View) can proceed:**

- Backend emits A2A events with all required fields
- ConversationId enables threading in UI
- Turn numbers enable message ordering
- Complete phase event signals conversation end
- Gateway broadcasts events to connected clients

**Blockers:** None

**Concerns:** None

## Related Phases

- **Phase 26-01:** Live agent message stream (foundation for event-driven UI)
- **Phase 27-01:** Conversation message stream (pattern for per-session message display)
- **Phase 27-02:** Auto-scroll and streaming (UX patterns for live updates)
- **Phase 27.1-02:** UI A2A conversation view (next step - consumes these events)

## Commits

| Hash      | Message                                                                     |
| --------- | --------------------------------------------------------------------------- |
| a1b5b9533 | feat(27.1-01): generate conversationId and emit A2A conversation events     |
| fdcc1fda4 | feat(27.1-01): add a2aContext parameter to runAgentStep and emit A2A events |
