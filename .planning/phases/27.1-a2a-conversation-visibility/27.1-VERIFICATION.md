---
phase: 27.1-a2a-conversation-visibility
verified: 2026-02-03T23:30:00Z
status: passed
score: 17/17 must-haves verified
---

# Phase 27.1: A2A Conversation Visibility Verification Report

**Phase Goal:** Inter-agent conversations (Ethos ↔ GSD ping-pong via sessions_send) are visible in the Agents tab as a threaded back-and-forth chat showing both sides of the conversation

**Verified:** 2026-02-03T23:30:00Z
**Status:** PASSED
**Re-verification:** No — initial verification

## Goal Achievement

### Observable Truths

| #   | Truth                                                                                                                        | Status     | Evidence                                                                                                                                                                            |
| --- | ---------------------------------------------------------------------------------------------------------------------------- | ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Every A2A ping-pong turn emits an event with stream 'a2a' containing conversationId, fromAgent, toAgent, turn, and text      | ✓ VERIFIED | agent-step.ts lines 68-81 emit A2A events with all required fields; sessions-send-tool.a2a.ts lines 62-92 emit turn 0/1; loop lines 129-135 pass a2aContext                         |
| 2   | The initial message and round-one reply are captured as turn 0 pair before the ping-pong loop                                | ✓ VERIFIED | sessions-send-tool.a2a.ts lines 62-92 emit turn 0 (requester message) and turn 1 (target reply) before loop at line 108                                                             |
| 3   | REPLY_SKIP responses do not emit a turn event -- they emit a 'complete' phase event instead                                  | ✓ VERIFIED | agent-step.ts line 68 filters with `!isReplySkip(replyText)` imported line 7; complete event at lines 148-157 always emits after loop                                               |
| 4   | The announce step does NOT emit an A2A turn event                                                                            | ✓ VERIFIED | sessions-send-tool.a2a.ts lines 168-174 runAgentStep call for announce has no a2aContext parameter                                                                                  |
| 5   | A2A conversation turns accumulate in a2aConversations signal keyed by conversationId                                         | ✓ VERIFIED | metrics.ts line 57 defines signal, lines 238-257 pushA2ATurn mutator appends turns, creates conversation if new                                                                     |
| 6   | AgentsController routes stream 'a2a' events to the a2aConversations signal                                                   | ✓ VERIFIED | agents-controller.ts lines 43-62 handle `stream === "a2a"`, call pushA2ATurn for phase "turn", finalizeA2AConversation for phase "complete"                                         |
| 7   | Completed A2A conversations are marked with status 'complete'                                                                | ✓ VERIFIED | metrics.ts lines 260-270 finalizeA2AConversation sets status: "complete"                                                                                                            |
| 8   | Signal mutations follow immutable Map pattern (new Map on every update)                                                      | ✓ VERIFIED | metrics.ts lines 239, 261 use `new Map(a2aConversations.get())` pattern matching sessionConversations                                                                               |
| 9   | Clicking a session card with A2A conversation data shows a threaded conversation view with both agents' messages interleaved | ✓ VERIFIED | agents.ts lines 98-123 render A2A badge, lines 40-42 route to renderA2AConversation; conversation-view.ts lines 249-467 render threaded view                                        |
| 10  | Each message in the A2A thread shows the agent's name, color, and turn number                                                | ✓ VERIFIED | conversation-view.ts lines 343-411 render agent avatar, name (line 373), color (line 372), and turn number (line 375)                                                               |
| 11  | Messages from the requester agent appear left-aligned, messages from the target appear right-aligned                         | ✓ VERIFIED | conversation-view.ts line 344-346 determine isRequester, line 346 set alignment "flex-start"/"flex-end", lines 354-365, 398-409 conditionally render avatar left/right              |
| 12  | Session cards with A2A conversations show a visual indicator (conversation badge)                                            | ✓ VERIFIED | agents.ts lines 98-123 render blue "A2A" badge when sessionA2ALinks has convIds for session, positioned absolutely top-right                                                        |
| 13  | The back button returns from A2A view to session list                                                                        | ✓ VERIFIED | conversation-view.ts line 250 onBack callback passed to renderA2AConversation, line 293-297 back button calls onBack; agents.ts line 42 onBack sets selectedA2AConversation to null |

**Score:** 13/13 truths verified

### Required Artifacts

| Artifact                                     | Expected                                                                                                          | Status     | Details                                                                                                                                                                                                                                                             |
| -------------------------------------------- | ----------------------------------------------------------------------------------------------------------------- | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `src/agents/tools/sessions-send-tool.a2a.ts` | conversationId generation, turn-0 emission, a2aContext passing                                                    | ✓ VERIFIED | 204 lines, contains conversationId (line 33), turn 0/1 emission (lines 62-92), a2aContext (lines 129-135), imports emitAgentEvent (line 4), resolveAgentIdFromSessionKey (line 7), exports function (line 20)                                                       |
| `src/agents/tools/agent-step.ts`             | a2aContext parameter, A2A event emission after step completion                                                    | ✓ VERIFIED | 86 lines, contains a2aContext parameter (lines 29-35), emits A2A event (lines 68-82), imports emitAgentEvent (line 3), isReplySkip (line 7), exported function (line 22)                                                                                            |
| `ui/src/ui/state/metrics.ts`                 | A2ATurnMessage type, A2AConversation type, a2aConversations signal, pushA2ATurn, finalizeA2AConversation mutators | ✓ VERIFIED | 280 lines, exports A2ATurnMessage (lines 32-41), A2AConversation (lines 43-49), a2aConversations signal (line 57), sessionA2ALinks computed (lines 75-89), pushA2ATurn (lines 238-257), finalizeA2AConversation (lines 260-270), resetMetrics clears a2a (line 278) |
| `ui/src/ui/controllers/agents-controller.ts` | A2A event routing in handleEvent method                                                                           | ✓ VERIFIED | 70 lines, imports pushA2ATurn, finalizeA2AConversation (lines 7-8), routes stream "a2a" (lines 43-62), turn events call pushA2ATurn (lines 48-58), complete events call finalizeA2AConversation (lines 59-61)                                                       |
| `ui/src/ui/views/conversation-view.ts`       | renderA2AConversation function for threaded A2A display                                                           | ✓ VERIFIED | 468 lines, exports renderA2AConversation (line 249), imports a2aConversations (line 10), A2AConversation type (line 3), uses getAgentIdentity (line 269-270), left/right alignment (lines 344-346), avatar rendering (lines 354-409), markdown (line 395)           |
| `ui/src/ui/views/agents.ts`                  | A2A conversation indicator on session cards, A2A view routing                                                     | ✓ VERIFIED | 2059 lines, imports sessionA2ALinks (line 29), a2aConversations (line 29), renderA2AConversation (line 30), selectedA2AConversation signal (line 36), A2A routing (lines 40-42), badge rendering (lines 98-123) with stopPropagation (line 105)                     |

**All artifacts substantive and wired.**

### Key Link Verification

| From                      | To                            | Via                                                   | Status  | Details                                                                                                                                                     |
| ------------------------- | ----------------------------- | ----------------------------------------------------- | ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| sessions-send-tool.a2a.ts | agent-step.ts                 | a2aContext parameter passed to runAgentStep           | ✓ WIRED | sessions-send-tool.a2a.ts lines 129-135 pass a2aContext to runAgentStep; agent-step.ts lines 29-35 accept parameter                                         |
| agent-step.ts             | infra/agent-events.ts         | emitAgentEvent with stream 'a2a'                      | ✓ WIRED | agent-step.ts line 3 imports emitAgentEvent, lines 69-81 call with stream: "a2a"                                                                            |
| agents-controller.ts      | metrics.ts (pushA2ATurn)      | import pushA2ATurn, finalizeA2AConversation           | ✓ WIRED | agents-controller.ts lines 7-8 import, lines 49-58 call pushA2ATurn, lines 60 call finalizeA2AConversation                                                  |
| conversation-view.ts      | metrics.ts (a2aConversations) | reads a2aConversations signal                         | ✓ WIRED | conversation-view.ts line 10 imports a2aConversations, line 250 reads via `.get().get(conversationId)`                                                      |
| agents.ts                 | metrics.ts (sessionA2ALinks)  | reads sessionA2ALinks computed signal                 | ✓ WIRED | agents.ts line 29 imports sessionA2ALinks, line 99 reads via `.get()`                                                                                       |
| agents.ts                 | conversation-view.ts          | calls renderA2AConversation when session has A2A data | ✓ WIRED | agents.ts line 30 imports renderA2AConversation, line 42 calls when selectedA2A is set, lines 98-123 render badge with click to set selectedA2AConversation |

**All key links wired.**

### Requirements Coverage

Phase 27.1 closes gaps in CHAT-01 and CHAT-02 from REQUIREMENTS.md:

| Requirement                        | Status      | Blocking Issue                                                |
| ---------------------------------- | ----------- | ------------------------------------------------------------- |
| CHAT-01: Live agent message stream | ✓ SATISFIED | A2A events emit and flow through gateway to UI                |
| CHAT-02: Conversation threading    | ✓ SATISFIED | A2A conversations thread by conversationId with turn ordering |

### Anti-Patterns Found

No anti-patterns detected. Scan of modified files found:

- ✓ No TODO/FIXME/XXX comments
- ✓ No placeholder content or empty implementations
- ✓ No console.log-only handlers
- ℹ️ UI placeholders (agents.ts lines 1001, 1928) are legitimate input field placeholders, not code stubs

### Human Verification Required

Phase 27.1 is fully verifiable programmatically. All truths verified via code inspection and wiring checks.

**No human verification needed** — all observable truths are structural (event emission, signal mutations, rendering logic) and verified through code analysis.

Optional manual testing (for UX validation, not goal verification):

1. **Visual A2A conversation appearance**
   - Test: Trigger A2A ping-pong (Ethos → GSD), observe Agents tab
   - Expected: Session card shows blue "A2A" badge, clicking opens threaded chat with left/right aligned messages
   - Why human: Visual polish and UX feel (code structure verified above)

2. **Auto-scroll behavior**
   - Test: Watch active A2A conversation, scroll up, then scroll back down
   - Expected: Auto-scroll pauses when scrolled up, resumes when at bottom
   - Why human: Scroll timing and feel (scroll logic verified in code)

3. **Markdown rendering**
   - Test: A2A message with markdown (code blocks, bold, lists)
   - Expected: Markdown renders correctly in message bubbles
   - Why human: Visual rendering (toSanitizedMarkdownHtml call verified)

### Gaps Summary

**No gaps found.** All must-haves verified.

---

_Verified: 2026-02-03T23:30:00Z_
_Verifier: Claude (gsd-verifier)_
